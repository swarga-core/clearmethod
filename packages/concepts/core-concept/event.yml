name: EVENT
description: |
  Abstract event system concept for inter-component communication.
  Events enable loose coupling between packages and workflow components.
  
  Implementations must provide:
  - Event emission (fire-and-forget or synchronous)
  - Subscription management
  - Event history and auditing
  - Handler execution with priority support

type: abstract

methods:
  emit:
    description: |
      Emit an event with specified type and payload.
      Triggers all subscribed handlers in priority order.
    params:
      - name: event_type
        type: string
        required: true
        description: Event type identifier (e.g., "task.created", "workflow.stage_completed")
      
      - name: payload
        type: object
        required: true
        description: Event data (must include task_id if event is task-related)
      
      - name: sync
        type: boolean
        required: false
        default: true
        description: Execute handlers synchronously (true) or asynchronously (false)
    
    returns:
      type: object
      description: |
        {
          event_id: string,
          handlers_executed: number,
          duration_ms: number
        }
  
  subscribe:
    description: |
      Subscribe a handler to specific event type.
      Handler will be triggered when event is emitted.
    params:
      - name: event_type
        type: string
        required: true
        description: Event type to subscribe to (supports wildcards like "task.*")
      
      - name: package
        type: string
        required: true
        description: Extension name that owns the handler
      
      - name: handler
        type: string
        required: true
        description: Handler method path (relative to package, e.g., "handlers/on_task_created")
      
      - name: filter
        type: object
        required: false
        description: Optional filters to narrow down events (e.g., {workflow: "sbd.feature"})
      
      - name: priority
        type: number
        required: false
        default: 100
        description: Handler priority (lower = executed earlier)
      
      - name: enabled
        type: boolean
        required: false
        default: true
        description: Whether subscription is active
    
    returns:
      type: string
      description: Subscription ID
  
  unsubscribe:
    description: Remove event subscription
    params:
      - name: subscription_id
        type: string
        required: true
        description: Subscription ID returned by subscribe()
    
    returns:
      type: boolean
      description: true if unsubscribed successfully
  
  get_history:
    description: |
      Retrieve event history with optional filters.
      Useful for auditing and debugging.
    params:
      - name: task_id
        type: string
        required: false
        description: Filter by task ID
      
      - name: event_type
        type: string
        required: false
        description: Filter by event type (supports wildcards)
      
      - name: limit
        type: number
        required: false
        default: 50
        description: Maximum number of events to return
      
      - name: since
        type: string
        required: false
        description: Return events since this timestamp (ISO 8601)
    
    returns:
      type: array
      description: |
        Array of event objects:
        [{
          id: string,
          type: string,
          timestamp: string,
          payload: object,
          handlers_executed: array,
          duration_ms: number
        }]
  
  list_subscriptions:
    description: List all active subscriptions
    params:
      - name: event_type
        type: string
        required: false
        description: Filter by event type
      
      - name: package
        type: string
        required: false
        description: Filter by package
    
    returns:
      type: array
      description: Array of subscription objects

standard_events:
  task:
    - task.created
    - task.updated
    - task.deleted
    - task.property_changed
    - task.state_changed
    - task.stage_started
    - task.stage_completed
    - task.workflow_started
    - task.workflow_completed
    - task.workflow_failed
    - task.transition_requested
    - task.transition_completed
  
  workflow:
    - workflow.precondition_checked
    - workflow.postcondition_checked
    - workflow.validation_failed
  
  quality:
    - quality.gate_checked
    - quality.gate_passed
    - quality.gate_failed
  
  vcs:
    - vcs.branch_created
    - vcs.commit_created
    - vcs.push_completed
    - vcs.pr_created
  
  context:
    - context.loaded
    - context.updated
    - context.file_added
  
  system:
    - package.registered
    - command.executed
    - error.occurred

