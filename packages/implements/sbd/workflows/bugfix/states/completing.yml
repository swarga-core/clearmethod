name: completing
description: "–§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–≥–∞"

preconditions:
  - TASK.get_property(task_id, "verification_complete") == true

instructions:
  - group: "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞–¥–∏–∏"
    do:
      - EVENT.emit("task.stage_started", {task_id: task_id, stage: "completing"})
      - TASK.set_property(task_id, "stage", "completing")
      - TASK.log(task_id, "üìã Finalizing bug fix")
  
  - group: "–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
    do:
      - info: "Document the fix for future reference"
      - let: fix_approach = TASK.get_property(task_id, "fix_approach")
      - let: files_modified = TASK.get_property(task_id, "files_modified")
      
      - write: ".cm/tasks/{task_id}/fix-summary.md"
        content: |
          # Bug Fix Summary
          
          ## Problem
          {TASK.get_property(task_id, "actual_behavior")}
          
          ## Root Cause
          {fix_approach}
          
          ## Solution
          Modified files: {files_modified}
          
          ## Testing
          - Created test: {TASK.get_property(task_id, "test_file")}
          - All tests pass
          - Manually verified
      
      - TASK.log(task_id, "Fix summary documented")
  
  - group: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–∏—Å—Ç–æ—Ç—ã"
    do:
      - info: "Ensure codebase is clean"
      - ask: "No debug code left? (yes/no)"
        into: code_clean
      - ask: "No commented out code? (yes/no)"
        into: no_comments
      
      - if: code_clean != "yes" || no_comments != "yes"
        then:
          - warn: "Please clean up the code before completing"
  
  - group: "–ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
    do:
      - info: "Ready to commit changes"
      - ask: "Commit message:"
        into: commit_message
      
      - TASK.set_property(task_id, "commit_message", commit_message)
      - TASK.log(task_id, "Suggested commit: {commit_message}")
  
  - group: "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ workflow"
    do:
      - TASK.set_property(task_id, "workflow_complete", true)
      - TASK.set_property(task_id, "final_status", "success")
      - TASK.set_state(task_id, "completed")
      
      - EVENT.emit("task.workflow_completed", {
          task_id: task_id,
          workflow: "sbd.bugfix",
          result: "success"
        })
      
      - TASK.log(task_id, "üéâ Bug fix completed successfully!")
      - info: "‚úÖ Workflow complete. Bug is fixed and verified!"

postconditions:
  - TASK.get_property(task_id, "workflow_complete") == true

